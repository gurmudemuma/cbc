version: '3.7'

# Docker Compose Override for Local Development with PostgreSQL
# This file extends docker-compose.yml to add PostgreSQL services for:
# - National Bank API (Prisma ORM)
# - Exporter Portal API (Prisma ORM)
#
# Usage:
#   docker-compose -f docker-compose.yml -f docker-compose.override.yml up
#
# The override automatically merges with the base docker-compose.yml

volumes:
  postgres-national-bank:
    driver: local
  postgres-exporter-portal:
    driver: local

services:
  # PostgreSQL for National Bank API
  postgres-national-bank:
    container_name: postgres-national-bank
    image: postgres:16-alpine
    environment:
      POSTGRES_USER: nationalbank
      POSTGRES_PASSWORD: nationalbank_dev_password
      POSTGRES_DB: national_bank_db
      POSTGRES_INITDB_ARGS: "--encoding=UTF8 --locale=en_US.UTF-8"
    ports:
      - "5432:5432"
    volumes:
      - postgres-national-bank:/var/lib/postgresql/data
    networks:
      - coffee-export
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U nationalbank -d national_bank_db"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    restart: unless-stopped
    command:
      - "postgres"
      - "-c"
      - "max_connections=100"
      - "-c"
      - "shared_buffers=256MB"

  # PostgreSQL for Exporter Portal API
  postgres-exporter-portal:
    container_name: postgres-exporter-portal
    image: postgres:16-alpine
    environment:
      POSTGRES_USER: exporter_portal
      POSTGRES_PASSWORD: exporter_portal_dev_password
      POSTGRES_DB: exporter_portal_db
      POSTGRES_INITDB_ARGS: "--encoding=UTF8 --locale=en_US.UTF-8"
    ports:
      - "5433:5432"
    volumes:
      - postgres-exporter-portal:/var/lib/postgresql/data
    networks:
      - coffee-export
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U exporter_portal -d exporter_portal_db"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    restart: unless-stopped
    command:
      - "postgres"
      - "-c"
      - "max_connections=100"
      - "-c"
      - "shared_buffers=256MB"

  # Optional: pgAdmin for database management UI
  pgadmin:
    container_name: pgadmin
    image: dpage/pgadmin4:latest
    environment:
      PGADMIN_DEFAULT_EMAIL: admin@coffee-export.local
      PGADMIN_DEFAULT_PASSWORD: admin
      PGADMIN_CONFIG_SERVER_MODE: "False"
    ports:
      - "5050:80"
    networks:
      - coffee-export
    depends_on:
      - postgres-national-bank
      - postgres-exporter-portal
    restart: unless-stopped
    volumes:
      - ./pgadmin-servers.json:/pgadmin4/servers.json:ro
