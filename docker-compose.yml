version: '3.7'

volumes:
  # Fabric network volumes
  orderer.coffee-export.com:
  peer0.exporterbank.coffee-export.com:
  peer0.nationalbank.coffee-export.com:
  peer0.ncat.coffee-export.com:
  peer0.shippingline.coffee-export.com:
  peer0.customauthorities.coffee-export.com:
  couchdb0:
  couchdb1:
  couchdb2:
  couchdb3:
  couchdb4:
  # IPFS volumes
  ipfs-data:
  ipfs-staging:
  # API wallet volumes
  exporter-bank-wallet:
  national-bank-wallet:
  ncat-wallet:
  shipping-line-wallet:
  custom-authorities-wallet:

networks:
  coffee-export:
    name: coffee-export-network

services:
  # ===========================
  # IPFS Service (Required)
  # ===========================
  ipfs:
    container_name: ipfs
    image: ipfs/kubo:v0.32.1
    environment:
      - IPFS_PROFILE=server
      - IPFS_PATH=/data/ipfs
    volumes:
      - ipfs-data:/data/ipfs
      - ipfs-staging:/export
    ports:
      - "4001:4001"      # Swarm
      - "4001:4001/udp"  # Swarm UDP
      - "5001:5001"      # API
      - "8080:8080"      # Gateway
    networks:
      - coffee-export
    healthcheck:
      test: ["CMD", "ipfs", "id"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    restart: unless-stopped

  # ===========================
  # Hyperledger Fabric Network
  # ===========================
  # Use the existing docker-compose.yaml for Fabric services
  # This extends the network/docker/docker-compose.yaml

  orderer.coffee-export.com:
    image: hyperledger/fabric-orderer:2.5
    labels:
      service: hyperledger-fabric
    environment:
      - FABRIC_LOGGING_SPEC=INFO
      - ORDERER_GENERAL_LISTENADDRESS=0.0.0.0
      - ORDERER_GENERAL_LISTENPORT=7050
      - ORDERER_GENERAL_LOCALMSPID=OrdererMSP
      - ORDERER_GENERAL_LOCALMSPDIR=/var/hyperledger/orderer/msp
      - ORDERER_GENERAL_TLS_ENABLED=true
      - ORDERER_GENERAL_TLS_PRIVATEKEY=/var/hyperledger/orderer/tls/server.key
      - ORDERER_GENERAL_TLS_CERTIFICATE=/var/hyperledger/orderer/tls/server.crt
      - ORDERER_GENERAL_TLS_ROOTCAS=[/var/hyperledger/orderer/tls/ca.crt]
      - ORDERER_GENERAL_CLUSTER_CLIENTCERTIFICATE=/var/hyperledger/orderer/tls/server.crt
      - ORDERER_GENERAL_CLUSTER_CLIENTPRIVATEKEY=/var/hyperledger/orderer/tls/server.key
      - ORDERER_GENERAL_CLUSTER_ROOTCAS=[/var/hyperledger/orderer/tls/ca.crt]
      - ORDERER_GENERAL_BOOTSTRAPMETHOD=none
      - ORDERER_CHANNELPARTICIPATION_ENABLED=true
      - ORDERER_ADMIN_TLS_ENABLED=true
      - ORDERER_ADMIN_TLS_CERTIFICATE=/var/hyperledger/orderer/tls/server.crt
      - ORDERER_ADMIN_TLS_PRIVATEKEY=/var/hyperledger/orderer/tls/server.key
      - ORDERER_ADMIN_TLS_ROOTCAS=[/var/hyperledger/orderer/tls/ca.crt]
      - ORDERER_ADMIN_TLS_CLIENTROOTCAS=[/var/hyperledger/orderer/tls/ca.crt]
      - ORDERER_ADMIN_LISTENADDRESS=0.0.0.0:7053
      - ORDERER_OPERATIONS_LISTENADDRESS=orderer.coffee-export.com:9443
      - ORDERER_METRICS_PROVIDER=prometheus
    working_dir: /root
    command: orderer
    volumes:
      - ./network/organizations/ordererOrganizations/coffee-export.com/orderers/orderer.coffee-export.com/msp:/var/hyperledger/orderer/msp
      - ./network/organizations/ordererOrganizations/coffee-export.com/orderers/orderer.coffee-export.com/tls:/var/hyperledger/orderer/tls
      - orderer.coffee-export.com:/var/hyperledger/production/orderer
    ports:
      - 7050:7050
      - 7053:7053
      - 9443:9443
    networks:
      - coffee-export

  # CouchDB instances (one per peer)
  couchdb0:
    container_name: couchdb0
    image: couchdb:3.3
    environment:
      - COUCHDB_USER=admin
      - COUCHDB_PASSWORD=adminpw
    ports:
      - 5984:5984
    networks:
      - coffee-export
    volumes:
      - couchdb0:/opt/couchdb/data

  couchdb1:
    container_name: couchdb1
    image: couchdb:3.3
    environment:
      - COUCHDB_USER=admin
      - COUCHDB_PASSWORD=adminpw
    ports:
      - 6984:5984
    networks:
      - coffee-export
    volumes:
      - couchdb1:/opt/couchdb/data

  couchdb2:
    container_name: couchdb2
    image: couchdb:3.3
    environment:
      - COUCHDB_USER=admin
      - COUCHDB_PASSWORD=adminpw
    ports:
      - 7984:5984
    networks:
      - coffee-export
    volumes:
      - couchdb2:/opt/couchdb/data

  couchdb3:
    container_name: couchdb3
    image: couchdb:3.3
    environment:
      - COUCHDB_USER=admin
      - COUCHDB_PASSWORD=adminpw
    ports:
      - 8984:5984
    networks:
      - coffee-export
    volumes:
      - couchdb3:/opt/couchdb/data

  couchdb4:
    container_name: couchdb4
    image: couchdb:3.3
    environment:
      - COUCHDB_USER=admin
      - COUCHDB_PASSWORD=adminpw
    ports:
      - 9984:5984
    networks:
      - coffee-export
    volumes:
      - couchdb4:/opt/couchdb/data

  # Peer nodes
  peer0.exporterbank.coffee-export.com:
    container_name: peer0.exporterbank.coffee-export.com
    image: hyperledger/fabric-peer:2.5
    environment:
      - FABRIC_LOGGING_SPEC=INFO
      - CORE_PEER_TLS_ENABLED=true
      - CORE_PEER_PROFILE_ENABLED=false
      - CORE_PEER_TLS_CERT_FILE=/etc/hyperledger/fabric/tls/server.crt
      - CORE_PEER_TLS_KEY_FILE=/etc/hyperledger/fabric/tls/server.key
      - CORE_PEER_TLS_ROOTCERT_FILE=/etc/hyperledger/fabric/tls/ca.crt
      - CORE_PEER_ID=peer0.exporterbank.coffee-export.com
      - CORE_PEER_ADDRESS=peer0.exporterbank.coffee-export.com:7051
      - CORE_PEER_LISTENADDRESS=0.0.0.0:7051
      - CORE_PEER_CHAINCODEADDRESS=peer0.exporterbank.coffee-export.com:7052
      - CORE_PEER_CHAINCODELISTENADDRESS=0.0.0.0:7052
      - CORE_PEER_GOSSIP_BOOTSTRAP=peer0.exporterbank.coffee-export.com:7051
      - CORE_PEER_GOSSIP_EXTERNALENDPOINT=peer0.exporterbank.coffee-export.com:7051
      - CORE_PEER_LOCALMSPID=ExporterBankMSP
      - CORE_PEER_MSPCONFIGPATH=/etc/hyperledger/fabric/msp
      - CORE_OPERATIONS_LISTENADDRESS=peer0.exporterbank.coffee-export.com:9444
      - CORE_METRICS_PROVIDER=prometheus
      - CHAINCODE_AS_A_SERVICE_BUILDER_CONFIG={"peername":"peer0exporterbank"}
      - CORE_CHAINCODE_EXECUTETIMEOUT=600s
      - CORE_VM_ENDPOINT=unix:///var/run/docker.sock
      - CORE_VM_DOCKER_HOSTCONFIG_NETWORKMODE=coffee-export-network
      - CORE_LEDGER_STATE_STATEDATABASE=CouchDB
      - CORE_LEDGER_STATE_COUCHDBCONFIG_COUCHDBADDRESS=couchdb0:5984
      - CORE_LEDGER_STATE_COUCHDBCONFIG_USERNAME=admin
      - CORE_LEDGER_STATE_COUCHDBCONFIG_PASSWORD=adminpw
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./network/organizations/peerOrganizations/exporterbank.coffee-export.com/peers/peer0.exporterbank.coffee-export.com:/etc/hyperledger/fabric
      - peer0.exporterbank.coffee-export.com:/var/hyperledger/production
      - ./config/core.yaml:/etc/hyperledger/fabric/core.yaml
    working_dir: /root
    command: peer node start
    ports:
      - 7051:7051
      - 9444:9444
    networks:
      - coffee-export
    depends_on:
      - couchdb0

  # NOTE: Additional peers (nationalbank, ncat, shippingline, customauthorities)
  # are defined in network/docker/docker-compose.yaml
  # For full deployment, use: docker-compose -f docker-compose.yml -f network/docker/docker-compose.yaml up

  # ===========================
  # CLI Tool
  # ===========================
  cli:
    container_name: cli
    image: hyperledger/fabric-tools:2.5
    tty: true
    stdin_open: true
    environment:
      - GOPATH=/opt/gopath
      - FABRIC_LOGGING_SPEC=INFO
    working_dir: /opt/gopath/src/github.com/hyperledger/fabric/peer
    command: /bin/bash
    volumes:
      - ./network/organizations:/opt/gopath/src/github.com/hyperledger/fabric/peer/organizations
      - ./network/scripts:/opt/gopath/src/github.com/hyperledger/fabric/peer/scripts/
      - ./network/channel-artifacts:/opt/gopath/src/github.com/hyperledger/fabric/peer/channel-artifacts
      - ./chaincode:/opt/gopath/src/github.com/hyperledger/fabric/peer/chaincode
      - ./bin:/opt/gopath/src/github.com/hyperledger/fabric/bin
      - ./config:/opt/gopath/src/github.com/hyperledger/fabric/config
    depends_on:
      - peer0.exporterbank.coffee-export.com
      - orderer.coffee-export.com
    networks:
      - coffee-export

  # ===========================
  # API Services (Optional - can run standalone or in containers)
  # ===========================
  # Uncomment these to run APIs in containers
  # NOTE: Requires building Docker images first

  # exporter-bank-api:
  #   build:
  #     context: ./api/exporter-bank
  #     dockerfile: Dockerfile
  #   container_name: exporter-bank-api
  #   environment:
  #     - PORT=3001
  #     - NODE_ENV=production
  #     - IPFS_HOST=ipfs
  #     - IPFS_PORT=5001
  #     - IPFS_PROTOCOL=http
  #     - ORGANIZATION_ID=exporterbank
  #     - ORGANIZATION_NAME=ExporterBank
  #     - MSP_ID=ExporterBankMSP
  #     - CHANNEL_NAME=coffeechannel
  #     - CHAINCODE_NAME_EXPORT=coffee-export
  #     - CHAINCODE_NAME_USER=user-management
  #   ports:
  #     - "3001:3001"
  #   networks:
  #     - coffee-export
  #   depends_on:
  #     - ipfs
  #     - peer0.exporterbank.coffee-export.com
  #   volumes:
  #     - exporter-bank-wallet:/app/wallet
  #     - ./network/organizations/peerOrganizations/exporterbank.coffee-export.com:/crypto
  #   restart: unless-stopped

  # ===========================
  # Frontend (Optional - can run standalone or in container)
  # ===========================
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: frontend
    ports:
      - "80:80"
    networks:
      - coffee-export
    # depends_on:
    #   - exporter-bank-api
    restart: unless-stopped
