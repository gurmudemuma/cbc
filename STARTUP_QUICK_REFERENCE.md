# Startup Quick Reference

Quick reference card for starting the Coffee Blockchain Consortium system.

---

## Automated Startup (Recommended)

```bash
./start-system.sh
```

**Options:**
- `--clean` - Clean start (removes all data)
- `--skip-deps` - Skip dependency installation

---

## Component Startup Order

### 1️⃣ Prerequisites (Always First)
- ✅ Docker daemon running
- ✅ Node.js, npm, Go installed
- ✅ Fabric binaries in PATH

### 2️⃣ Blockchain Network
```bash
cd network
./network.sh up              # Generates crypto + starts containers
```
**Wait:** 15-20 seconds

### 3️⃣ Channel Creation
```bash
./network.sh createChannel   # Creates and joins channel
```
**Wait:** 10-15 seconds

### 4️⃣ Chaincode Deployment
```bash
# Deploy both chaincodes (order doesn't matter)
./network.sh deployCC -ccn coffee-export -ccp ../chaincode/coffee-export -ccl go
./network.sh deployCC -ccn user-management -ccp ../chaincode/user-management -ccl go
```
**Wait:** 2-5 minutes per chaincode

### 5️⃣ Admin Enrollment
```bash
cd ..
./scripts/enroll-admins.sh   # Creates admin identities
```
**Wait:** 5-10 seconds

### 6️⃣ API Services
```bash
./scripts/dev-apis.sh        # Starts all APIs in tmux
```
**OR start individually:**
```bash
cd api/exporter-bank && npm run dev &
cd api/national-bank && npm run dev &
cd api/ncat && npm run dev &
cd api/shipping-line && npm run dev &
```
**Wait:** 15-20 seconds per API

### 7️⃣ IPFS (Optional)
```bash
ipfs daemon &
```
**Wait:** 5-10 seconds

### 8️⃣ Frontend
```bash
cd frontend
npm run dev
```
**Wait:** 5-10 seconds

### 9️⃣ User Registration (Optional)
```bash
./scripts/register-test-users.sh
```

---

## Critical Rules

### ⚠️ DO NOT START OUT OF ORDER

**Wrong Order = Failures:**
- ❌ APIs before blockchain → Connection errors
- ❌ Chaincode before channel → Deployment fails
- ❌ Channel before network → No peers to join
- ❌ Frontend before APIs → Cannot connect

**Correct Order:**
```
Docker → Network → Channel → Chaincode → Admins → APIs → Frontend
```

---

## Dependency Chain

```
┌─────────────────┐
│  Docker Daemon  │ ← Must be running first
└────────┬────────┘
         ↓
┌─────────────────┐
│ Crypto Material │ ← Generated by network.sh up
└────────┬��───────┘
         ↓
┌─────────────────┐
│   Containers    │ ← Orderer + 4 Peers + CouchDB
└────────┬────────┘
         ↓
┌─────────────────┐
│     Channel     │ ← coffeechannel
└────────┬────────┘
         ↓
┌─────────────────┐
│   Chaincodes    │ ← coffee-export + user-management
└────────┬────────┘
         ↓
┌─────────────────┐
│ Admin Enrolled  │ ← Wallet identities created
└────────┬────────┘
         ↓
┌─────────────────┐
│   API Services  │ ← 4 APIs on ports 3001-3004
└────────┬────────┘
         ↓
┌─────────────────┐
│    Frontend     │ ← Port 5173
└─────────────────┘
```

---

## Verification Commands

After each step, verify before proceeding:

### After Network Start
```bash
docker ps | grep hyperledger
# Should show: orderer + 4 peers + 4 couchdb
```

### After Channel Creation
```bash
docker exec peer0.exporterbank.coffee-export.com peer channel list
# Should show: coffeechannel
```

### After Chaincode Deployment
```bash
docker exec peer0.exporterbank.coffee-export.com peer lifecycle chaincode queryinstalled
# Should show: coffee-export_1.0, user-management_1.0
```

### After Admin Enrollment
```bash
ls api/exporter-bank/wallet/
# Should show: admin.id
```

### After API Start
```bash
curl http://localhost:3001/health
curl http://localhost:3002/health
curl http://localhost:3003/health
curl http://localhost:3004/health
# All should return: {"status":"ok"}
```

### After Frontend Start
```bash
curl http://localhost:5173
# Should return HTML
```

---

## Timing Guide

| Step | Component | Time | Cumulative |
|------|-----------|------|------------|
| 1 | Prerequisites | 10s | 10s |
| 2 | Network Start | 20s | 30s |
| 3 | Channel Creation | 15s | 45s |
| 4 | Chaincode Deploy (×2) | 240s | 285s |
| 5 | Admin Enrollment | 10s | 295s |
| 6 | API Services | 60s | 355s |
| 7 | IPFS | 10s | 365s |
| 8 | Frontend | 10s | 375s |
| 9 | User Registration | 20s | 395s |

**Total First Start:** ~6-7 minutes
**Restart (no chaincode):** ~2 minutes

---

## Common Mistakes

### ❌ Starting APIs Too Early
**Symptom:** "Failed to connect to blockchain"
**Fix:** Wait for chaincode deployment to complete

### ❌ Missing Admin Enrollment
**Symptom:** "Admin identity not found"
**Fix:** Run `./scripts/enroll-admins.sh`

### ❌ Channel Not Created
**Symptom:** "Channel does not exist"
**Fix:** Run `./network.sh createChannel`

### ❌ Ports Already in Use
**Symptom:** "Port 3001 already in use"
**Fix:** Kill existing processes or use `--clean` flag

---

## Quick Troubleshooting

### Network Won't Start
```bash
cd network
./network.sh down
docker system prune -f
./network.sh up
```

### APIs Won't Connect
```bash
# Check blockchain is running
docker ps | grep peer0.exporterbank

# Check admin enrolled
ls api/exporter-bank/wallet/

# Check connection profiles
ls network/organizations/peerOrganizations/exporterbank.coffee-export.com/connection-*.json
```

### Clean Restart
```bash
./start-system.sh --clean
```

---

## Port Reference

| Service | Port | Required |
|---------|------|----------|
| Orderer | 7050 | ✅ Yes |
| Peer 0 (Exporter) | 7051 | ✅ Yes |
| Peer 0 (National) | 8051 | ✅ Yes |
| Peer 0 (NCAT) | 9051 | ✅ Yes |
| Peer 0 (Shipping) | 10051 | ✅ Yes |
| Exporter Bank API | 3001 | ✅ Yes |
| National Bank API | 3002 | ✅ Yes |
| NCAT API | 3003 | ✅ Yes |
| Shipping Line API | 3004 | ✅ Yes |
| IPFS API | 5001 | ⚠️ Optional |
| Frontend | 5173 | ✅ Yes |

---

## Stop System

### Stop All Services
```bash
# Stop APIs
tmux kill-session -t cbc-apis
tmux kill-session -t cbc-frontend

# OR
pkill -f "npm run dev"

# Stop IPFS
pkill -f "ipfs daemon"

# Stop blockchain
cd network
./network.sh down
```

### Clean Everything
```bash
./scripts/clean.sh
```

---

## Restart Scenarios

### Quick Restart (Everything Running)
```bash
# Just restart APIs if needed
tmux kill-session -t cbc-apis
./scripts/dev-apis.sh
```

### Full Restart (Clean State)
```bash
./start-system.sh --clean
```

### After Code Changes

**Chaincode Changes:**
```bash
cd network
./network.sh down
./network.sh up createChannel
./network.sh deployCC -ccn coffee-export -ccp ../chaincode/coffee-export -ccl go
cd ..
./scripts/enroll-admins.sh
./scripts/dev-apis.sh
```

**API Changes:**
```bash
# Just restart APIs (hot reload should work)
tmux kill-session -t cbc-apis
./scripts/dev-apis.sh
```

**Frontend Changes:**
```bash
# Hot reload should work automatically
# If not, restart:
tmux kill-session -t cbc-frontend
cd frontend && npm run dev
```

---

## Health Check Script

```bash
./scripts/check-health.sh
```

This checks all components and reports status.

---

## Related Documentation

- **[STARTUP_ORDER.md](STARTUP_ORDER.md)** - Detailed startup documentation
- **[QUICK_START.md](QUICK_START.md)** - Getting started guide
- **[README.md](README.md)** - Project overview

---

**Remember:** Always follow the order. Each component depends on the previous ones!

**Last Updated:** 2024
