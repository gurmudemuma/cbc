# Docker Compose with Secrets Management
# Use this for production deployments with proper secret handling
version: '3.7'

secrets:
  couchdb_user:
    file: ./secrets/couchdb_user.txt
  couchdb_password:
    file: ./secrets/couchdb_password.txt
  jwt_secret_exporter_bank:
    file: ./secrets/jwt_secret_exporter_bank.txt
  jwt_secret_national_bank:
    file: ./secrets/jwt_secret_national_bank.txt
  jwt_secret_ncat:
    file: ./secrets/jwt_secret_ncat.txt
  jwt_secret_shipping_line:
    file: ./secrets/jwt_secret_shipping_line.txt
  jwt_secret_custom_authorities:
    file: ./secrets/jwt_secret_custom_authorities.txt

volumes:
  # Fabric network volumes
  orderer.coffee-export.com:
  peer0.commercialbank.coffee-export.com:
  peer0.nationalbank.coffee-export.com:
  peer0.ecta.coffee-export.com:
  peer0.shippingline.coffee-export.com:
  peer0.customauthorities.coffee-export.com:
  couchdb0:
  couchdb1:
  couchdb2:
  couchdb3:
  couchdb4:
  # IPFS volumes
  ipfs-data:
  ipfs-staging:
  # API wallet volumes
  commercialbank-wallet:
  national-bank-wallet:
  ncat-wallet:
  shipping-line-wallet:
  custom-authorities-wallet:
  # Redis volume
  redis-data:

networks:
  coffee-export:
    name: coffee-export-network

services:
  # ===========================
  # IPFS Service
  # ===========================
  ipfs:
    container_name: ipfs
    image: ipfs/kubo:v0.32.1
    environment:
      - IPFS_PROFILE=server
      - IPFS_PATH=/data/ipfs
    volumes:
      - ipfs-data:/data/ipfs
      - ipfs-staging:/export
    ports:
      - "4001:4001"
      - "4001:4001/udp"
      - "5001:5001"
      - "8080:8080"
    networks:
      - coffee-export
    healthcheck:
      test: ["CMD", "ipfs", "id"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    restart: unless-stopped

  # ===========================
  # Redis Cache
  # ===========================
  redis:
    container_name: redis
    image: redis:7-alpine
    command: redis-server --requirepass ${REDIS_PASSWORD:-changeme}
    volumes:
      - redis-data:/data
    ports:
      - "6379:6379"
    networks:
      - coffee-export
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5
    restart: unless-stopped

  # ===========================
  # CouchDB instances with secrets
  # ===========================
  couchdb0:
    container_name: couchdb0
    image: couchdb:3.3
    secrets:
      - couchdb_user
      - couchdb_password
    environment:
      - COUCHDB_USER_FILE=/run/secrets/couchdb_user
      - COUCHDB_PASSWORD_FILE=/run/secrets/couchdb_password
    ports:
      - 5984:5984
    networks:
      - coffee-export
    volumes:
      - couchdb0:/opt/couchdb/data
    restart: unless-stopped

  couchdb1:
    container_name: couchdb1
    image: couchdb:3.3
    secrets:
      - couchdb_user
      - couchdb_password
    environment:
      - COUCHDB_USER_FILE=/run/secrets/couchdb_user
      - COUCHDB_PASSWORD_FILE=/run/secrets/couchdb_password
    ports:
      - 6984:5984
    networks:
      - coffee-export
    volumes:
      - couchdb1:/opt/couchdb/data
    restart: unless-stopped

  couchdb2:
    container_name: couchdb2
    image: couchdb:3.3
    secrets:
      - couchdb_user
      - couchdb_password
    environment:
      - COUCHDB_USER_FILE=/run/secrets/couchdb_user
      - COUCHDB_PASSWORD_FILE=/run/secrets/couchdb_password
    ports:
      - 7984:5984
    networks:
      - coffee-export
    volumes:
      - couchdb2:/opt/couchdb/data
    restart: unless-stopped

  couchdb3:
    container_name: couchdb3
    image: couchdb:3.3
    secrets:
      - couchdb_user
      - couchdb_password
    environment:
      - COUCHDB_USER_FILE=/run/secrets/couchdb_user
      - COUCHDB_PASSWORD_FILE=/run/secrets/couchdb_password
    ports:
      - 8984:5984
    networks:
      - coffee-export
    volumes:
      - couchdb3:/opt/couchdb/data
    restart: unless-stopped

  couchdb4:
    container_name: couchdb4
    image: couchdb:3.3
    secrets:
      - couchdb_user
      - couchdb_password
    environment:
      - COUCHDB_USER_FILE=/run/secrets/couchdb_user
      - COUCHDB_PASSWORD_FILE=/run/secrets/couchdb_password
    ports:
      - 9984:5984
    networks:
      - coffee-export
    volumes:
      - couchdb4:/opt/couchdb/data
    restart: unless-stopped

  # Note: Orderer and Peer configurations remain the same as docker-compose.yml
  # They use certificate-based authentication which is already secure
